<template>
    <div v-if="options" class="filt" @submit.prevent>
        <div class="filt--container">
            <InputSearch
                :placeholder="query.search.toString()"
                :results="searchResults"
                @value="searchStudio($event)"
            />
            <hr>
            <DistrictsSelect
                :city="$store.state.cities.currentCity"
            />
            <MetroSelect
                :city="$store.state.cities.currentCity"
            />
            <hr
                v-if="$store.state.cities.districtsByCurrentCity.length
                    || $store.state.cities.metroByCurrentCity.length"
            >
            <div class="studio_type">
                <Checkbox
                    v-for="(studio_type, key) in options.studio_type"
                    :key="key"
                    :item="studio_type"
                    :parent="query.studio_type"
                    @mouseup.native="checkboxHandle('studio_type', key)"
                />
            </div>
            <hr>
            <div class="models_age">
                <div class="inner">
                    <nRadio
                        v-for="(models_age, key) in options.models_age"
                        :key="key"
                        :item="models_age"
                        :selector="'models_age'"
                        :selected="query.models_age.toString()"
                        @mouseup.native="radioHandle('models_age', key)"
                    />
                </div>
            </div>
            <hr>
            <div class="working_with_model_types">
                <Checkbox
                    v-for="(model_types, key) in options.working_with_model_types"
                    :key="key"
                    :item="model_types"
                    :parent="query.working_with_model_types"
                    @mouseup.native="checkboxHandle('working_with_model_types', key)"
                />
            </div>
            <hr>
            <div class="min_payout_percentage">
                <Range
                    :label="'Минимальный % выплат'"
                    :val="+query.min_payout_percentage"
                    :min="30"
                    :max="90"
                    @valueChange="rangeHandle($event, 'min_payout_percentage')"
                />
            </div>
            <hr>
            <div class="shift_length">
                <Range
                    :label="'Длина смены'"
                    :val="+query.shift_length"
                    :min="5"
                    :max="12"
                    @valueChange="rangeHandle($event, 'shift_length')"
                />
            </div>
            <hr>
            <div class="max_shifts_per_week">
                <Range
                    :label="'Дней в неделю минимум'"
                    :val="+query.max_shifts_per_week"
                    :min="3"
                    :max="6"
                    @valueChange="rangeHandle($event, 'max_shifts_per_week')"
                />
            </div>
            <hr>
            <div class="staff_gender form-module">
                <nSelect
                    :options="arrayFrom(options.staff_gender)"
                    :placeholder="'Пол администраторов'"
                    static-placeholder
                    @selectedOption="selectHandle($event, 'staff_gender')"
                />
                <div v-if="query.staff_gender.length && options.staff_gender" class="selected-options">
                    <div class="badge" @click="query.staff_gender = []">
                        {{ nameByKeys('staff_gender').toString() }}
                    </div>
                </div>
            </div>
            <hr>
            <div v-if="options.devices" class="devices form-module">
                <MultiSelect
                    :options="arrayFrom(options.devices)"
                    :placeholder="`Камеры`"
                    :selected="nameByKeys('devices')"
                    @selectedOptions="selectHandle($event, 'devices')"
                />
            </div>
            <hr>
            <div class="conditions">
                <Checkbox
                    :key="'true'"
                    :item="'Сертифицирована'"
                    :parent="query.certified"
                    @mouseup.native="checkboxHandle('certified', 'true')"
                />
                <Checkbox
                    v-for="(support_staff, key) in options.support_staff"
                    :key="key"
                    :item="support_staff"
                    :parent="query.support_staff"
                    @mouseup.native="checkboxHandle('support_staff', key)"
                />
                <Checkbox
                    v-for="(studio_condition, key) in options.conditions"
                    :key="key"
                    :item="studio_condition"
                    :parent="query.conditions"
                    @mouseup.native="checkboxHandle('conditions', key)"
                />
            </div>
        </div>
        <button class="close-btn" @click="$emit('close')" />
        <footer class="filt--footer">
            <div class="filt--footer-top">
                <p>
                    <b>{{ currentStudiosLength }}</b> из {{ allStudioLength }}
                </p>
                <button class="reset" @click="filtReset" />
                <button class="accept" @click="$emit('close')" />
            </div>
            <div class="filt--footer-bottom">
                Послать заявку {{ currentStudiosLength }} отобранным
            </div>
        </footer>
    </div>
</template>

<script>
import Checkbox from '@/components/form/Checkbox';
import nRadio from '@/components/form/nRadio';
import Range from '@/components/form/Range';
import nSelect from '@/components/nSelect';
import MultiSelect from '@/components/MultiSelect';
import InputSearch from '@/components/form/InputSearch';

import DistrictsSelect from '@/components/form/modules/DistrictsSelect';
import MetroSelect from '@/components/form/modules/MetroSelect';

import { arrayFrom, toArray } from '@/helpers';
import { eventBus } from '@/main';

export default {
  name: 'Filt',
  components: {
    nSelect,
    MultiSelect,
    Checkbox,
    nRadio,
    Range,
    // MultiRange,
    InputSearch,
    DistrictsSelect,
    MetroSelect,
  },
  data() {
    return {
      query: {
        search: [],
        studio_type: [],
        models_age: [],
        working_with_model_types: [],
        min_payout_percentage: [],
        shift_length: [],
        max_shifts_per_week: [],
        staff_gender: [],
        devices: [],
        conditions: [],
        support_staff: [],
        certified: [],
      },
    };
  },
  computed: {
    options() {
      return this.$store.state.studios.optionsStudios;
    },
    searchResults() {
      return this.$store.state.studios.currentStudios.map((el) => el.name);
    },
    currentStudiosLength() {
      return this.$store.state.studios.currentStudiosLength || 0;
    },
    allStudioLength() {
      return this.$store.getters.allStudiosLength || 0;
    },
  },
  watch: {
    query: {
      handler() {
        this.queryBuild();
      },
      deep: true,
    },

  },
  mounted() {
    if (localStorage.filterQuery) {
      this.query = JSON.parse(localStorage.filterQuery);
    }
    if (localStorage.currentCity) this.$store.dispatch('updateCurrentCity', localStorage.currentCity);
    if (localStorage.selectedDistricts) {
      this.$store.dispatch('updateSelectedDistricts',
        JSON.parse(localStorage.selectedDistricts)); 
    }
    if (localStorage.selectedMetro) {
      this.$store.dispatch('updateSelectedMetro',
        JSON.parse(localStorage.selectedMetro));
    }
  },
  methods: {
    arrayFrom,
    searchStudio(name) {
      if (name.length) {
        this.query.search = name;
        this.$store.dispatch('updateSearchQuery', `&search=${name}`);
      } else {
        this.query.search = '';
        this.$store.dispatch('updateSearchQuery', '');
      }
      localStorage.filterQuery = JSON.stringify(this.query);
    },
    checkboxHandle(selector, payload) {
      toArray(this.query[selector], payload).toString();
    },
    radioHandle(selector, payload) {
      this.query[selector] = payload;
    },
    rangeHandle(payload, selector) {
      this.query[selector] = payload;
    },
    selectHandle(payload, selector) {
      this.query[selector] = [];
      for (const [key, value] of Object.entries(this.options[selector])) {
        if (payload.includes(value)) {
          this.query[selector].push(key);
        }
      }
    },
    queryBuild() {
      this.$store.commit('updatePageNumber', 1);
      let queryString = '';
      for (const field in this.query) {
        if (this.query[field].length) {
          queryString += `&${field}=${this.query[field]}`;
        }
      }
      this.$store.dispatch('updateFilterQuery', queryString);
      localStorage.filterQuery = JSON.stringify(this.query);
    },
    filtReset() {
      this.$emit('filtReset');
      eventBus.$emit('resetSelects');
      this.$store.commit('updateSearchQuery', '');
      this.$store.dispatch('updateCurrentCity', this.$store.state.cities.currentCity);
      localStorage.selectedDistricts = this.$store.state.cities.selectedDistricts;
      localStorage.selectedMetro = this.$store.state.cities.selectedMetro;
      for (const field in this.query) {
        if (this.query) {
          this.query[field] = [];
        }
      }
      localStorage.filterQuery = JSON.stringify(this.query);
      this.$store.dispatch('updateFilterQuery', '');
    },

    nameByKeys(selector) {
      return this.query[selector].map((el) => this.options[selector][el]);
    },
  },
};
</script>

<style lang="scss">
@mixin icon {
    display: none;
    width: var(--fr);
    height: var(--fr);
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    @content;
}
@mixin item {
    background-color: var(--white);
    border: 1px solid #c4c4cd;
    border-radius: 0.5rem;
    padding: var(--fr-m) 0.875rem;
}

.filt {
  width: 300px;
  background-color: var(--grey-filt);
  border-radius: 0px 20px 0px 0px;
  &--container {
      padding: 28px;
  }
  hr {
      border: 1px solid var(--grey-hr);
      margin: 28px 0;
  }
  .filt--footer {
    position: sticky;
    bottom: 0;
    left: 0;
    height: 120px;
    & > * {
      width: 100%;
      height: 50%;
      display: flex;
      align-items: center;
    }
    &-top {
      justify-content: space-between;
      background-color: #ffbee1;
      padding: 20px 20px 20px 20px;
      p {
          font-size: 20px;
          margin-right: 30px;
      }
    }
    &-bottom {
      justify-content: center;
      background: linear-gradient(272.12deg, #e9dbff 0%, #cdf1ff 100%);
    }
    .reset {
      width: 85px;
      height: 40px;
      background-color: rgba(#a5527e, 0.2);
      border-radius: 8px;
      margin-right: 10px;
      &::after {
        content: "Сброс";
      }
    }
    .accept {
      width: 120px;
      height: 40px;
      background-color: white;
      border-radius: 8px;
      &::after {
        content: "Применить";
      }
    }
  }
    .input-search {
        input {
            border-radius: 37px;
            padding-left: 35px;
        }
        &::after {
            content: "";
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 0.875rem;
            height: 0.875rem;
            background: no-repeat center / contain url("~@/assets/svg/i-search.svg");
        }
    }
  .badge:last-of-type {
  margin-bottom: 0;
}
}

.models_age {
  .inner {
        position: relative;
        display: flex;
        width: max-content;
        @include item;
        padding: 4px;
        &::after {
            content: "лет";
            position: absolute;
            right: -40px;
            top: 50%;
            transform: translateY(-60%);
            color: #606074;
        }
    }
}

.working_with_model_types,
.conditions {
  display: flex;
  flex-wrap: wrap;
}

@media screen and (min-width: 420px) {
  .filt {
    .filt--footer {
      .reset {
        width: 140px;
        margin-right: 0;
        &::after {
            content: "Сбросить всё";
        }
      }
      .accept {
        display: none;
      }
   }
      .close-btn {
        display: none;
    }
  }

}

@media screen and (min-width: 1360px) {
    .filt {
        border-top-left-radius: var(--fr);
        .filt--footer {
            width: 100%;
        }
    }
}
</style>
